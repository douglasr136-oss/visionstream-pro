<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <title>VISIONSTREAM PRO</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.10/dist/hls.min.js"></script>
    
    <style>
        /* ==================== ESTILOS GERAIS ==================== */
        :root {
            --primary: #9333EA;
            --primary-dark: #7C3AED;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --dark: #0a0a0a;
            --darker: #050505;
            --card-bg: #1a1a1a;
            --card-border: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --neon-purple: #c084fc;
            --neon-green: #4ade80;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker), var(--dark));
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }
        
        /* ==================== LAYOUT ==================== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
        }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        /* ==================== HEADER ==================== */
        .app-header {
            background: linear-gradient(90deg, var(--dark), var(--primary-dark));
            padding: 20px;
            text-align: center;
            border-bottom: 3px solid var(--primary);
            margin-bottom: 20px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .logo-icon {
            font-size: 40px;
            color: var(--neon-green);
        }
        
        .logo-text {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(45deg, var(--neon-purple), var(--neon-green));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        /* ==================== PAIN√âIS ==================== */
        .panel {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .panel-icon {
            font-size: 24px;
            color: var(--primary);
            background: rgba(147, 51, 234, 0.1);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .panel-title {
            font-size: 22px;
            font-weight: 700;
        }
        
        /* ==================== FORMUL√ÅRIOS ==================== */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .form-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
        }
        
        .form-input {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            padding: 15px;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(45deg, var(--success), #059669);
            color: white;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--card-border);
        }
        
        .status-indicator {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--warning);
        }
        
        .status-indicator.active {
            border-left-color: var(--success);
        }
        
        /* ==================== PROVEDORES ==================== */
        .provider-buttons {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .provider-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }
        
        .provider-btn:hover {
            background: rgba(147, 51, 234, 0.1);
            border-color: var(--primary);
        }
        
        .provider-btn.active {
            background: rgba(147, 51, 234, 0.15);
            border-color: var(--primary);
        }
        
        .provider-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, var(--primary), var(--success));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        /* ==================== STATS ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--neon-green);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* ==================== PLAYER ==================== */
        .video-container {
            position: relative;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            aspect-ratio: 16/9;
            margin-bottom: 20px;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            background: #000;
        }
        
        .player-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            color: var(--text-secondary);
        }
        
        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }
        
        .channel-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        /* ==================== BUSCA E CATEGORIAS ==================== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 16px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        
        .categories-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .category-tab {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .category-tab.active {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        /* ==================== GRADE DE CANAIS ==================== */
        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .channel-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .channel-card:hover {
            background: rgba(147, 51, 234, 0.1);
            border-color: var(--primary);
            transform: translateY(-5px);
        }
        
        .channel-logo {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            overflow: hidden;
        }
        
        .channel-info {
            text-align: center;
        }
        
        .channel-name {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .channel-category {
            font-size: 12px;
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 3px 10px;
            border-radius: 10px;
            display: inline-block;
        }
        
        .empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
        }
        
        /* ==================== NOTIFICA√á√ïES ==================== */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border-left: 4px solid var(--primary);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }
        
        .notification-success {
            border-left-color: var(--success);
        }
        
        .notification-error {
            border-left-color: var(--danger);
        }
        
        .notification-warning {
            border-left-color: var(--warning);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ==================== RESPONSIVO ==================== */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .panel {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .channels-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="app-header">
        <div class="logo-container">
            <div class="logo-icon">
                <i class="fas fa-satellite-dish"></i>
            </div>
            <div>
                <div class="logo-text">VISIONSTREAM PRO</div>
                <div style="color: var(--text-secondary); font-size: 14px; margin-top: 5px;">
                    STREAMING DE ALTA PERFORMANCE
                </div>
            </div>
        </div>
    </header>

    <!-- Container Principal -->
    <div class="container">
        <!-- Coluna Esquerda -->
        <div class="left-column">
            <!-- Painel de Ativa√ß√£o -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div>
                        <div class="panel-title">ATIVA√á√ÉO DO SISTEMA</div>
                        <div class="panel-subtitle">Informe seu MAC e KEY para acessar o conte√∫do</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ENDERE√áO MAC</label>
                    <input type="text" id="mac" class="form-input" 
                           placeholder="Ex: A1:B2:C3:D4:E5:F6"
                           value="A1:B2:C3:D4:E5:F6">
                </div>
                
                <div class="form-group">
                    <label class="form-label">CHAVE DE LICEN√áA</label>
                    <input type="text" id="key" class="form-input" 
                           placeholder="Ex: VISION-XXXX-XXXX"
                           value="VISION-7A3B-9C2D">
                </div>
                
                <div class="button-group">
                    <button id="activateBtn" class="btn btn-primary">
                        <i class="fas fa-unlock-alt"></i>
                        Ativar Sistema
                    </button>
                    <button id="resetBtn" class="btn btn-secondary">
                        <i class="fas fa-redo"></i>
                        Resetar
                    </button>
                </div>
                
                <div id="statusText" class="status-indicator">
                    <i class="fas fa-clock"></i>
                    <span>Aguardando ativa√ß√£o</span>
                </div>
            </div>

            <!-- Painel de Provedores -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-server"></i>
                    </div>
                    <div>
                        <div class="panel-title">GERENCIADOR DE LISTAS IPTV</div>
                        <div class="panel-subtitle">SISTEMA DE PROVEDORES</div>
                    </div>
                </div>
                
                <div class="provider-buttons" id="providerButtons">
                    <!-- Preenchido pelo JavaScript -->
                </div>
                
                <div class="button-group">
                    <button id="reloadBtn" class="btn btn-success">
                        <i class="fas fa-sync-alt"></i>
                        Recarregar Lista
                    </button>
                </div>
            </div>

            <!-- Painel de Estat√≠sticas -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div>
                        <div class="panel-title">LISTA CARREGADA</div>
                        <div class="panel-subtitle">Estat√≠sticas da playlist atual</div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="channelCount">0</div>
                        <div class="stat-label">Canais</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="categoryCount">0</div>
                        <div class="stat-label">Categorias</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="lastUpdate">Nunca</div>
                        <div class="stat-label">√öltima Atualiza√ß√£o</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coluna Direita -->
        <div class="right-column">
            <!-- Painel do Player -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-play-circle"></i>
                    </div>
                    <div>
                        <div class="panel-title">PLAYER VISIONSTREAM</div>
                        <div class="panel-subtitle">VISIONSTREAM PRO Player</div>
                    </div>
                </div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls playsinline preload="auto"></video>
                    
                    <div id="playerPlaceholder" class="player-placeholder">
                        <i class="fas fa-satellite-dish"></i>
                        <div style="text-align: center;">
                            <h3 style="margin-bottom: 10px;">PLAYER VISIONSTREAM</h3>
                            <p>Carregue uma lista IPTV e selecione um canal para come√ßar</p>
                        </div>
                    </div>
                </div>
                
                <div class="player-controls">
                    <div class="channel-info">
                        <h4 id="currentChannel">Canal Atual: Nenhum</h4>
                        <div class="channel-status" id="streamStatus">Status: Aguardando</div>
                    </div>
                    <button id="fullscreenBtn" class="btn btn-secondary">
                        <i class="fas fa-expand"></i>
                        Tela Cheia
                    </button>
                </div>
            </div>

            <!-- Painel de Canais -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-icon">
                        <i class="fas fa-list"></i>
                    </div>
                    <div>
                        <div class="panel-title">CANAIS DISPON√çVEIS</div>
                        <div class="panel-subtitle">Selecione um canal para assistir</div>
                    </div>
                </div>
                
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="channelSearch" placeholder="Buscar canal ou categoria...">
                </div>
                
                <div class="categories-tabs" id="categoriesTabs">
                    <!-- Preenchido pelo JavaScript -->
                </div>
                
                <div class="channels-grid" id="channelsGrid">
                    <div class="empty-state">
                        <i class="fas fa-broadcast-tower"></i>
                        <h3>Nenhum canal carregado</h3>
                        <p>Carregue uma lista IPTV para visualizar os canais dispon√≠veis</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifica√ß√µes -->
    <div id="notificationsContainer"></div>

    <!-- Script Principal -->
    <script>
        // ==================== CONFIGURA√á√ÉO ====================
        const CONFIG = {
            BACKEND_URL: 'https://visionstream-proxy.onrender.com',
            API_KEY: 'visionstream_prod_1735661234',
            PROVIDERS: {
                'provider1': { name: 'Provedor Principal', icon: 'fa-wifi' },
                'provider2': { name: 'Provedor Secund√°rio', icon: 'fa-satellite-dish' }
            }
        };

        // ==================== ESTADO DA APLICA√á√ÉO ====================
        let appState = {
            activated: false,
            channels: [],
            categories: [],
            currentChannel: null,
            currentCategory: 'all',
            currentProvider: 'provider1',
            searchTerm: ''
        };

        let hls = null;

        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ VISIONSTREAM PRO Inicializando...');
            
            initProviderSelector();
            initEventListeners();
            loadFromLocalStorage();
            
            // Mostrar notifica√ß√£o inicial
            setTimeout(() => {
                showNotification('VISIONSTREAM PRO Carregado! Ative o sistema.', 'info');
            }, 1000);
        });

        // ==================== SELE√á√ÉO DE PROVEDOR ====================
        function initProviderSelector() {
            const container = document.getElementById('providerButtons');
            if (!container) return;
            
            container.innerHTML = Object.entries(CONFIG.PROVIDERS).map(([id, provider]) => `
                <div class="provider-btn" data-provider="${id}" id="providerBtn_${id}">
                    <div class="provider-icon">
                        <i class="fas ${provider.icon}"></i>
                    </div>
                    <div class="provider-info">
                        <h4>${provider.name}</h4>
                        <span class="provider-status" id="status_${id}">üî¥ Offline</span>
                    </div>
                    <div class="provider-action">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                </div>
            `).join('');
            
            // Adicionar eventos
            Object.keys(CONFIG.PROVIDERS).forEach(id => {
                const btn = document.getElementById(`providerBtn_${id}`);
                if (btn) {
                    btn.addEventListener('click', () => selectProvider(id));
                }
            });
        }

        function selectProvider(providerId) {
            if (!appState.activated) {
                showNotification('Ative o sistema primeiro!', 'error');
                return;
            }
            
            // Atualizar UI
            document.querySelectorAll('.provider-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const btn = document.getElementById(`providerBtn_${providerId}`);
            if (btn) btn.classList.add('active');
            
            // Carregar playlist
            appState.currentProvider = providerId;
            loadM3UPlaylist(providerId);
        }

        // ==================== CARREGAMENTO DE PLAYLIST ====================
        async function loadM3UPlaylist(providerName) {
            try {
                console.log('üéØ Iniciando carga da playlist para:', providerName);
                showNotification('üîÑ Conectando ao provedor...', 'info');
                
                // URL da API
                const proxyUrl = `${CONFIG.BACKEND_URL}/api/playlist?provider=${providerName}&_=${Date.now()}`;
                console.log('üîó URL:', proxyUrl);
                
                // Fazer requisi√ß√£o
                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Accept': 'audio/x-mpegurl, text/plain, */*'
                    }
                });
                
                console.log('üì• Status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const m3uContent = await response.text();
                console.log('‚úÖ Recebido:', m3uContent.length, 'bytes');
                
                // Mostrar amostra
                const lines = m3uContent.split('\n');
                console.log('üìÑ Primeiras 5 linhas:', lines.slice(0, 5).join('\n'));
                
                // Parse M3U
                const parsed = parseM3U(m3uContent);
                console.log('‚úÖ Parseado:', parsed.channels.length, 'canais');
                
                appState.channels = parsed.channels;
                appState.categories = parsed.categories;
                appState.currentProvider = providerName;
                
                // Atualizar UI
                updateUI();
                
                // Salvar no localStorage
                saveToLocalStorage();
                
                showNotification(`‚úÖ ${parsed.channels.length} canais carregados!`, 'success');
                
            } catch (error) {
                console.error('üí• ERRO:', error);
                console.error('Stack:', error.stack);
                
                showNotification(`Erro: ${error.message}`, 'error');
                
                // Carregar dados de fallback
                loadLocalFallback();
            }
        }

        function parseM3U(content) {
            const lines = content.split('\n');
            const channels = [];
            const categories = new Set(['Geral']);
            
            let currentChannel = {};
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('#EXTINF:')) {
                    // Extrair nome
                    const lastComma = line.lastIndexOf(',');
                    const name = lastComma > -1 ? line.substring(lastComma + 1).trim() : 'Canal sem nome';
                    
                    // Extrair grupo
                    let group = 'Geral';
                    const groupMatch = line.match(/group-title="([^"]*)"/i);
                    if (groupMatch) group = groupMatch[1];
                    
                    // Extrair logo
                    let logo = '';
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/i);
                    if (logoMatch) logo = logoMatch[1];
                    
                    currentChannel = { name, group, logo, url: '' };
                    categories.add(group);
                    
                } else if (line && !line.startsWith('#') && currentChannel.name) {
                    currentChannel.url = line.trim();
                    if (currentChannel.url.startsWith('http')) {
                        channels.push({...currentChannel});
                    }
                    currentChannel = {};
                }
            }
            
            return {
                channels: channels,
                categories: Array.from(categories).sort()
            };
        }

        // ==================== ATUALIZA√á√ÉO DA UI ====================
        function updateUI() {
            // Estat√≠sticas
            document.getElementById('channelCount').textContent = appState.channels.length;
            document.getElementById('categoryCount').textContent = appState.categories.length;
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('pt-BR');
            
            // Categorias
            updateCategories();
            
            // Canais
            updateChannels();
        }

        function updateCategories() {
            const container = document.getElementById('categoriesTabs');
            if (!container) return;
            
            let html = `
                <button class="category-tab ${appState.currentCategory === 'all' ? 'active' : ''}" 
                        onclick="setCategory('all')">
                    Todos (${appState.channels.length})
                </button>
            `;
            
            appState.categories.forEach(cat => {
                const count = appState.channels.filter(c => c.group === cat).length;
                if (count > 0) {
                    html += `
                        <button class="category-tab ${appState.currentCategory === cat ? 'active' : ''}" 
                                onclick="setCategory('${cat}')">
                            ${cat} (${count})
                        </button>
                    `;
                }
            });
            
            container.innerHTML = html;
        }

        function updateChannels() {
            const container = document.getElementById('channelsGrid');
            if (!container) return;
            
            // Filtrar canais
            let filtered = appState.channels;
            if (appState.currentCategory !== 'all') {
                filtered = filtered.filter(c => c.group === appState.currentCategory);
            }
            if (appState.searchTerm) {
                const term = appState.searchTerm.toLowerCase();
                filtered = filtered.filter(c => 
                    c.name.toLowerCase().includes(term) || 
                    c.group.toLowerCase().includes(term)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>Nenhum canal encontrado</h3>
                        <p>Tente outra busca ou selecione outra categoria</p>
                    </div>
                `;
                return;
            }
            
            // Mostrar canais (limitar a 100)
            const displayChannels = filtered.slice(0, 100);
            container.innerHTML = displayChannels.map((channel, index) => `
                <div class="channel-card" onclick="playChannel(${index})">
                    <div class="channel-logo">
                        ${channel.logo ? 
                            `<img src="${channel.logo}" alt="${channel.name}" onerror="this.style.display='none'">` : 
                            `<i class="fas fa-tv"></i>`
                        }
                    </div>
                    <div class="channel-info">
                        <div class="channel-name" title="${channel.name}">${channel.name}</div>
                        <div class="channel-category">${channel.group}</div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== PLAYER ====================
        function playChannel(index) {
            const channel = appState.channels[index];
            if (!channel || !channel.url) {
                showNotification('Canal inv√°lido', 'error');
                return;
            }
            
            console.log('üé¨ Reproduzindo:', channel.name);
            console.log('üîó URL:', channel.url);
            
            // Atualizar UI
            document.getElementById('currentChannel').textContent = `Canal Atual: ${channel.name}`;
            document.getElementById('streamStatus').textContent = 'Status: Conectando...';
            document.getElementById('streamStatus').style.color = 'var(--warning)';
            
            // Mostrar player
            document.getElementById('playerPlaceholder').style.display = 'none';
            const video = document.getElementById('videoPlayer');
            video.style.display = 'block';
            
            // Destruir HLS anterior
            if (hls) {
                hls.destroy();
                hls = null;
            }
            
            // Remover overlay de play
            const playOverlay = document.getElementById('playOverlay');
            if (playOverlay) playOverlay.remove();
            
            // Configurar fonte do v√≠deo
            video.src = '';
            
            // Verificar se √© HLS
            const isHLS = channel.url.includes('.m3u8');
            
            if (isHLS && typeof Hls !== 'undefined' && Hls.isSupported()) {
                // Usar HLS.js
                hls = new Hls({
                    enableWorker: true,
                    lowLatencyMode: true
                });
                
                hls.loadSource(channel.url);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('‚úÖ Manifesto HLS carregado');
                    video.play().catch(e => {
                        console.log('‚ö†Ô∏è Autoplay bloqueado:', e.name);
                        showPlayOverlay();
                    });
                });
                
                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('‚ùå Erro HLS:', data);
                });
                
            } else {
                // Reprodu√ß√£o direta
                video.src = channel.url;
                video.load();
                video.play().catch(e => {
                    console.log('‚ö†Ô∏è Autoplay bloqueado:', e.name);
                    showPlayOverlay();
                });
            }
           // Configura√ß√£o OTIMIZADA do HLS
hls = new Hls({
    enableWorker: true,
    enableSoftwareAES: true,
    debug: false,
    
    // Buffer otimizado
    maxBufferSize: 60 * 1000 * 1000, // 60MB
    maxBufferLength: 30,
    maxMaxBufferLength: 60,
    liveSyncDurationCount: 3,
    liveMaxLatencyDurationCount: 10,
    
    // Qualidade/ABR
    abrEwmaFastLive: 3,
    abrEwmaSlowLive: 9,
    abrEwmaFastVoD: 3,
    abrEwmaSlowVoD: 9,
    abrBandWidthFactor: 0.8,
    abrBandWidthUpFactor: 0.7,
    
    // Timeouts
    manifestLoadingTimeOut: 10000,
    manifestLoadingMaxRetry: 3,
    levelLoadingTimeOut: 10000,
    levelLoadingMaxRetry: 3,
    fragLoadingTimeOut: 20000,
    fragLoadingMaxRetry: 6,
    
    // Outras otimiza√ß√µes
    stretchShortVideoTrack: true,
    maxFragLookUpTolerance: 0.2,
    liveDurationInfinity: false,
    enableWebVTT: true,
    enableCEA708Captions: true,
    captionsTextTrack1Label: 'Legendas',
    captionsTextTrack1LanguageCode: 'pt'
});
        // ==================== FUN√á√ïES AUXILIARES ====================
        function setCategory(category) {
            appState.currentCategory = category;
            updateCategories();
            updateChannels();
        }

        function loadLocalFallback() {
            console.log('üîÑ Carregando dados locais de fallback...');
            
            appState.channels = [
                { name: 'GLOBO HD', group: 'Abertos', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'SBT HD', group: 'Abertos', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'RECORD HD', group: 'Abertos', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'BAND HD', group: 'Abertos', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'HBO HD', group: 'Filmes', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' },
                { name: 'ESPN HD', group: 'Esportes', logo: '', url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' }
            ];
            
            appState.categories = ['Abertos', 'Filmes', 'Esportes'];
            
            updateUI();
            showNotification('Usando dados de demonstra√ß√£o', 'warning');
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationsContainer') || document.body;
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'exclamation-circle';
            if (type === 'warning') icon = 'exclamation-triangle';
            
            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('visionstream_data', JSON.stringify({
                    channels: appState.channels,
                    categories: appState.categories,
                    provider: appState.currentProvider,
                    timestamp: Date.now()
                }));
            } catch (e) {
                console.error('Erro ao salvar:', e);
            }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('visionstream_data');
                if (data) {
                    const parsed = JSON.parse(data);
                    if (parsed.channels) appState.channels = parsed.channels;
                    if (parsed.categories) appState.categories = parsed.categories;
                    if (parsed.provider) appState.currentProvider = parsed.provider;
                    
                    // Se h√° dados, ativar automaticamente
                    if (parsed.channels && parsed.channels.length > 0) {
                        appState.activated = true;
                        document.getElementById('statusText').innerHTML = `
                            <i class="fas fa-check-circle" style="color: var(--success);"></i>
                            <span>Sistema ativado (cache)</span>
                        `;
                        document.getElementById('statusText').classList.add('active');
                        updateUI();
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar:', e);
            }
        }
        // ==================== FUN√á√ïES GLOBAIS ====================
        try {
            window.playChannel = playChannel;
            window.setCategory = setCategory;
            window.showNotification = showNotification;
            console.log('‚úÖ Fun√ß√µes globais registradas');
        } catch (e) {
            console.error('‚ùå Erro ao registrar fun√ß√µes globais:', e);
        }
    </script>
</body>
</html>
